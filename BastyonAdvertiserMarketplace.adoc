## Bastyon Decentralized Ad Marketplace

The Bastyon Decentralized Ad Marketplace will enable sponsored content on the Bastyon social media site through a new transaction type called Ad Post.  Both the advertiser and recipient of the advertiser will agree to the transaction.  This model allows advertisers to target specific audiences, and allows content creators 
the power to choose what types of advertisements are allowed on their channel, versus ceding control to a centralized advertisement authority as it the case with mainstream social media platforms.

## Example Usage Model

. Blogger sets price for an ad
 Node: add to user info
 Front End: create transaction Set Price for text/image or video (different prices)

. Advertiser creates a special type of a post – Ad Post. It contains a partially signed Ad transaction with an ad for a given blogger. All that remains is the blogger’s signature. It is attached as text to the Ad Post. Inputs have to be non-wallet inputs and cannot be moved (on the front end) until the time expiration (3 days for the ad). 
PKOIN is added that is equal to the price of the blogger is Set Price (text/image or video different)
..Node: new transaction Ad Post
..Don’t allow to move money from the input that is used in the ad transaction for 3 days [3 days seems short]

. Advertiser can look for bloggers to offer the post to by using search based on :
.. Number of followers: NF
.. Categories/Hashtags used
.. Activity (number of ratings/comments underneath the posts)
.. Video or textual
.. Price for an ad per follower
.. Percentage of ads accepted
.. Similar bloggers based on an initial set of bloggers (Recommended bloggers by bloggers – API call exists)
... Node: API calls to power the search
... Front End: Intuitive search form, as bloggers are added, sum recalculated
. Multi-sig tx is attached to an Ad Post as a post
. Blogger opens an Ad Offers report, reviews the ad and decides to repost or not
... Front End: create a report for a blogger to review all ads, reputation of the advertiser

. When reposting blogger’s front end checks that the PKOIN input is still valid, and then sends the Multisig tx (which is a repost) to the node. *blogger cannot delete an ad*


## Blockchain Implementation

The proposed method to implement Ad Post on the blockchain is through a conditional time locked script which the blogger can redeem within a specified time period (initialially 3 days or 4320 blocks.  Below is the workflow for two users exchanging in a AdPost transaction.  Bob is a prospective advertiser who wishes to advertise on Alice's feed.

1. Bob creates a standard post content transaction on the Bastyon platform which contains the content he wishes to advertise.

2. Bob creates an AdPost transaction which contains the payment amount, a AdPost payload pointing to the TX hash of the transaction in step 1, and the below script in the scriptPubKey:
```
 OP_IF <<
    "ad" << OP_EQUALVERIFY <<
    OP_DUP << OP_HASH160 << [Alice PubKeyHash] << OP_EQUALVERIFY << OP_CHECKSIG <<
 OP_ELSE << 
     4320 << OP_CHECKSEQUENCEVERIFY << OP_DROP <<
     OP_DUP << OP_HASH160 << [Bob's PubKeyHash] << OP_EQUALVERIFY << OP_CHECKSIG <<
 OP_ENDIF;
```
The top "IF" case requires the scriptSig (unlock script) to have the ascii characters "ad" pushed onto the stack followed by Alice's pubkey hash.  The "ad" characters indicate to the PocketNet nodes that additional consensus checks are required to ensure the correct AdPost payload is present on the transaction and that the target contest exists on the blockchain.
The bottom "ELSE" case begins with a sequence lock which prevents Bob from reclaiming the funds until 4320 blocks have passed (3 days).


3a. Alice posts the redemption script as a transaction to the blockchain within the three day time period.  Funds are transfered from the P2SH script back to
Alice's wallet.  Acceptance of the redemption script let's the nodes know that Alice has accepted the add and it should be reported as
part of Alice's feed. [Potential exploit, make sure it is not possible to run the redemption script without posting the add]

3b. After a three day time period, Bob opens the Bastyon client which scans for his wallet transactions.  Since the three day time
period has elapsed, the redeption script run's automatically and returns the funds from the P2SH address back to Bob's wallet address.

### Script
P2SH transaction to send coin outputs from Bob to Alice
HASH160 <Redeem script hash> EQUAL


Redeem Script:
```

IF
  <Alice's Pubkey> CHECKSIGVERIFY
ELSE
  <3 days> CHECKSEQUENCEVERIFY DROP
  <Bob's Pubkey> CHECKSIGVERIFY
ENDIF
  

```
Unlocking Script called with Redeem script for Alice (gauranteed before 3 days then until Bob runs unlocking script):

```
<Alice's Sig><Alice's PubKey> TRUE
```

Unlocking script prepended to redeem script for Bob (after 3 days):
```
<Bob's Sig><Bob's PubKey> FALSE
```

## References
Mastering Bitcoin: Using Flow Control in Scripts - https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch07.asciidoc#using-flow-control-in-scripts

Mastering Bitcoin: P2SH Address - https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch07.asciidoc#p2sh-addresses

Mastering Bitcoin: Script - https://github.com/bitcoinbook/bitcoinbook/blob/develop/appdx-scriptops.asciidoc#L56

BIP 112 - CHECKSEQUENCEVERIFY - https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki


## Test Plan
Develop unit test to verify each step in workflow above between to parties.
Unit test to verify advertised content appears as expected in target feed.

